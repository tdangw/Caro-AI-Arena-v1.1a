import{r as n,a as q,ap as G,j as t,f as J,J as K,aq as Q}from"./index-iVqpNyTX.js";const Y=["Good move!","Nice!","Well played.","Thinking...","Good luck!"],O=["❤️","😂","👍"],X=({isOpen:h,onClose:k,chatId:d,currentUserId:x,senderName:u,recipientName:m,onMessageSent:g,isReadOnly:b=!1,recipientId:C})=>{const[p,H]=n.useState([]),[j,y]=n.useState(""),[R,M]=n.useState(!1),[S,T]=n.useState(null),E=n.useRef(null),i=n.useRef(null),[B,$]=n.useState(!1),{playSound:L}=q(),[v,I]=n.useState(10),f=(e="smooth")=>{var l;(l=E.current)==null||l.scrollIntoView({behavior:e})};n.useEffect(()=>{if(h&&d){const e=G(d,l=>{const s=i.current,a=s?s.scrollHeight-s.clientHeight<=s.scrollTop+50:!0;H(l),a&&setTimeout(()=>f("smooth"),100)});return setTimeout(()=>f("auto"),300),()=>e()}},[h,d]);const z=()=>{const e=i.current;if(e){const{scrollTop:l,scrollHeight:s,clientHeight:a}=e;$(s-l-a>200)}},w=async e=>{const l=e.trim();l&&(L("select"),await Q(d,x,u,l),g==null||g(l),y(""),setTimeout(()=>f("smooth"),50))},D=(e,l)=>{w(`REACT:${l}:${e}`),T(null)},F=e=>{y(l=>l+e.emoji),M(!1)},A=n.useMemo(()=>{const e={[x]:u},l=C||d.split("_").find(s=>s!==x);return l&&(e[l]=m),e},[x,u,m,d,C]),{processedMessages:N,reactionsMap:P}=n.useMemo(()=>{const e=new Map,l=[];if(!Array.isArray(p))return console.error("ChatBox received a non-array `messages` state:",p),{processedMessages:[],reactionsMap:e};for(const s of p)try{if(typeof(s==null?void 0:s.id)!="string"||typeof(s==null?void 0:s.senderId)!="string"||typeof(s==null?void 0:s.text)!="string"){console.warn("Skipping malformed message object:",s);continue}if(s.text.startsWith("REACT:")){const a=s.text.split(":");if(a.length!==3)continue;const[,o,c]=a;if(!c||!o)continue;let r=e.get(c);r||(r={},e.set(c,r)),Array.isArray(r[o])||(r[o]=[]),r[o].includes(s.senderId)||r[o].push(s.senderId)}else l.push(s)}catch(a){console.error("Error processing a chat message:",s,a)}return{processedMessages:l,reactionsMap:e}},[p]),W=n.useMemo(()=>N.slice(-v),[N,v]),_=()=>{const e=i.current;if(e){const l=e.scrollHeight,s=e.scrollTop;I(a=>{const o=a+10;return requestAnimationFrame(()=>{if(i.current){const c=i.current.scrollHeight;i.current.scrollTop=s+(c-l)}}),o})}};return h?t.jsxs("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",onClick:k,children:[t.jsxs("div",{className:"bg-slate-900/20 backdrop-blur-md border border-slate-700 rounded-xl w-full max-w-sm flex flex-col animate-scale-in relative",style:{height:"500px"},onClick:e=>e.stopPropagation(),children:[t.jsxs("header",{className:"flex-shrink-0 flex items-center justify-between p-3 border-b border-slate-700",children:[t.jsxs("h3",{className:"text-lg font-semibold text-white",children:[b?"Chat History":"Chat"," with ",m]}),t.jsx("button",{onClick:k,className:"text-slate-400 hover:text-white text-2xl leading-none",children:"×"})]}),t.jsxs("div",{className:"flex-grow relative overflow-hidden",children:[t.jsxs("div",{ref:i,onScroll:z,className:"absolute inset-0 p-3 overflow-y-auto scrollbar-hide",children:[N.length>v&&t.jsx("div",{className:"text-center my-2",children:t.jsx("button",{onClick:_,className:"bg-slate-700 text-slate-300 text-xs px-3 py-1 rounded-full hover:bg-slate-600 transition-colors",children:"Load More"})}),W.map(e=>{const l=P.get(e.id),s=e.senderId===x;return t.jsxs("div",{className:`flex flex-col mb-1 group relative ${s?"items-end":"items-start"}`,children:[t.jsx("div",{className:"text-xs text-slate-400 px-1 mb-1",children:s?u:m}),t.jsxs("div",{className:`flex items-end gap-2 ${s?"flex-row-reverse":"flex-row"}`,children:[t.jsx("div",{className:`inline-block max-w-[80%] lg:max-w-sm rounded-lg px-2 py-2 text-sm break-words ${s?"bg-cyan-600/50 text-white":"bg-slate-700/50 text-slate-200"}`,children:e.text}),!b&&t.jsx("button",{onClick:()=>T(S===e.id?null:e.id),className:"text-slate-500 hover:text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity text-xs pb-1",children:"😊"})]}),S===e.id&&t.jsx("div",{className:`flex gap-2 p-1 bg-slate-800 rounded-full mt-1 ${s?"mr-10":"ml-10"}`,children:O.map(a=>t.jsx("button",{onClick:()=>D(e.id,a),className:"text-lg hover:scale-125 transition-transform",children:a},a))}),l&&t.jsx("div",{className:`flex gap-1 mt-1 flex-wrap ${s?"justify-end":"justify-start"}`,children:Object.entries(l).map(([a,o])=>{if(!Array.isArray(o)||o.length===0)return null;const c=o.map(r=>A[r]||"...").join(", ");return t.jsxs("div",{title:c,className:"bg-slate-700/50 rounded-full px-2 py-0.5 text-xs flex items-center gap-1 cursor-pointer",children:[t.jsx("span",{children:a}),t.jsx("span",{className:"text-slate-300 font-medium",children:o.length>1?o.length:A[o[0]]||"..."})]},a)})}),t.jsx("span",{className:"text-xs text-slate-500 mt-1 px-1",children:J(e.timestamp)})]},e.id)}),t.jsx("div",{ref:E})]}),B&&t.jsx("button",{onClick:()=>f("smooth"),className:"absolute bottom-4 left-1/2 -translate-x-1/2 z-10 bg-slate-700/80 backdrop-blur-sm text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-slate-600 transition-all animate-fade-in-up","aria-label":"Scroll to latest messages",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}),!b&&t.jsxs("div",{className:"flex-shrink-0 p-2 border-t border-slate-700 relative",children:[R&&t.jsx("div",{className:"absolute bottom-full left-0 right-0 p-2 bg-slate-900/90 rounded-t-lg grid grid-cols-6 gap-1",children:K.slice(0,18).map(e=>t.jsx("button",{onClick:()=>F(e),className:"text-2xl rounded-md hover:bg-slate-700 transition-colors p-1",children:e.emoji},e.id))}),t.jsx("div",{className:"flex gap-1 overflow-x-auto scrollbar-hide mb-2",children:Y.map(e=>t.jsx("button",{onClick:()=>w(e),className:"flex-shrink-0 bg-slate-700 text-slate-300 text-xs px-2 py-1 rounded-full hover:bg-slate-600",children:e},e))}),t.jsxs("form",{onSubmit:e=>{e.preventDefault(),w(j)},className:"flex gap-2",children:[t.jsx("button",{type:"button",onClick:()=>M(e=>!e),className:"bg-slate-700 text-lg px-3 rounded-lg hover:bg-slate-600",children:"😊"}),t.jsxs("div",{className:"relative flex-grow",children:[t.jsx("input",{type:"text",value:j,onChange:e=>y(e.target.value),placeholder:"Type a message...",className:"w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 pr-12",maxLength:100}),t.jsxs("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 pointer-events-none",children:[j.length,"/100"]})]}),t.jsx("button",{type:"submit",className:"bg-cyan-500 text-black font-bold px-4 rounded-lg hover:bg-cyan-400",children:"Send"})]})]})]}),t.jsx("style",{children:`
                @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
                @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
            `})]}):null};export{X as C};
